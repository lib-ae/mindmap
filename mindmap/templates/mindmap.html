<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>思维导图编辑器</title>
    <link href="../static/css/style.css" rel="stylesheet">
    <link href="../static/css/mindmap.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <input type="text" id="mindmap-title" placeholder="输入标题..." class="title-input">
            <div class="header-actions">
                <button onclick="saveMindmap()" class="btn btn-primary">保存</button>
                <button onclick="location.href='../../index.html'" class="btn btn-secondary">返回</button>
            </div>
        </header>

        <main>
            <div id="mindmap-container"></div>
            <div class="toolbar">
                <button onclick="addNode()" class="btn btn-sm">添加节点</button>
                <button onclick="deleteSelectedNode()" class="btn btn-sm btn-danger">删除节点</button>
                <input type="color" id="node-color" onchange="updateNodeColor(this.value)" title="节点颜色">
                <select id="node-shape" onchange="updateNodeShape(this.value)" title="节点形状">
                    <option value="rectangle">矩形</option>
                    <option value="ellipse">椭圆</option>
                    <option value="diamond">菱形</option>
                </select>
            </div>
        </main>
    </div>

    <script>
        // 获取URL参数中的mindmap ID
        const urlParams = new URLSearchParams(window.location.search);
        const mapId = urlParams.get('id');
        let mindmapData = null;
        let selectedNode = null;

        // 初始化D3
        const width = window.innerWidth;
        const height = window.innerHeight - 100;
        const svg = d3.select('#mindmap-container')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        // 加载思维导图数据
        function loadMindmap() {
            const data = localStorage.getItem(`mindmap_${mapId}`);
            if (data) {
                mindmapData = JSON.parse(data);
                document.getElementById('mindmap-title').value = mindmapData.title;
                renderMindmap();
            } else {
                mindmapData = {
                    title: '新思维导图',
                    nodes: [{
                        id: 'root',
                        text: '中心主题',
                        x: width / 2,
                        y: height / 2,
                        color: '#ff9900',
                        shape: 'ellipse'
                    }],
                    links: []
                };
                renderMindmap();
            }
        }

        // 渲染思维导图
        function renderMindmap() {
            // 清空现有内容
            svg.selectAll('*').remove();

            // 绘制连接线
            svg.selectAll('line')
                .data(mindmapData.links)
                .enter()
                .append('line')
                .attr('x1', d => {
                    const source = mindmapData.nodes.find(n => n.id === d.source);
                    return source.x;
                })
                .attr('y1', d => {
                    const source = mindmapData.nodes.find(n => n.id === d.source);
                    return source.y;
                })
                .attr('x2', d => {
                    const target = mindmapData.nodes.find(n => n.id === d.target);
                    return target.x;
                })
                .attr('y2', d => {
                    const target = mindmapData.nodes.find(n => n.id === d.target);
                    return target.y;
                })
                .attr('stroke', '#999')
                .attr('stroke-width', 2);

            // 创建节点组
            const nodes = svg.selectAll('g')
                .data(mindmapData.nodes)
                .enter()
                .append('g')
                .attr('transform', d => `translate(${d.x},${d.y})`)
                .call(d3.drag()
                    .on('drag', dragged)
                    .on('end', dragended));

            // 根据形状绘制节点
            nodes.each(function(d) {
                const node = d3.select(this);
                if (d.shape === 'rectangle') {
                    node.append('rect')
                        .attr('width', 120)
                        .attr('height', 40)
                        .attr('x', -60)
                        .attr('y', -20)
                        .attr('fill', d.color || '#fff')
                        .attr('stroke', '#000');
                } else if (d.shape === 'ellipse') {
                    node.append('ellipse')
                        .attr('rx', 60)
                        .attr('ry', 20)
                        .attr('fill', d.color || '#fff')
                        .attr('stroke', '#000');
                } else if (d.shape === 'diamond') {
                    node.append('path')
                        .attr('d', 'M0,-20L60,0L0,20L-60,0Z')
                        .attr('fill', d.color || '#fff')
                        .attr('stroke', '#000');
                }
            });

            // 添加文本
            nodes.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.3em')
                .text(d => d.text)
                .on('dblclick', editNodeText);

            // 添加点击事件
            nodes.on('click', selectNode);
        }

        // 节点拖拽处理
        function dragged(event, d) {
            d.x = event.x;
            d.y = event.y;
            d3.select(this).attr('transform', `translate(${d.x},${d.y})`);
            
            // 更新连接线
            svg.selectAll('line')
                .filter(l => l.source === d.id || l.target === d.id)
                .attr('x1', l => {
                    const source = mindmapData.nodes.find(n => n.id === l.source);
                    return source.x;
                })
                .attr('y1', l => {
                    const source = mindmapData.nodes.find(n => n.id === l.source);
                    return source.y;
                })
                .attr('x2', l => {
                    const target = mindmapData.nodes.find(n => n.id === l.target);
                    return target.x;
                })
                .attr('y2', l => {
                    const target = mindmapData.nodes.find(n => n.id === l.target);
                    return target.y;
                });
        }

        function dragended() {
            saveMindmap();
        }

        // 选择节点
        function selectNode(event, d) {
            if (selectedNode === d) {
                selectedNode = null;
                d3.selectAll('g').classed('selected', false);
            } else {
                selectedNode = d;
                d3.selectAll('g').classed('selected', false);
                d3.select(this).classed('selected', true);
                
                // 更新工具栏状态
                document.getElementById('node-color').value = d.color || '#ffffff';
                document.getElementById('node-shape').value = d.shape || 'rectangle';
            }
        }

        // 编辑节点文本
        function editNodeText(event, d) {
            const newText = prompt('输入节点文本：', d.text);
            if (newText !== null) {
                d.text = newText;
                d3.select(this).text(newText);
                saveMindmap();
            }
        }

        // 添加新节点
        function addNode() {
            if (!selectedNode) {
                alert('请先选择一个节点！');
                return;
            }

            const newNode = {
                id: 'node_' + Date.now(),
                text: '新节点',
                x: selectedNode.x + 150,
                y: selectedNode.y,
                color: '#ffffff',
                shape: 'rectangle'
            };

            mindmapData.nodes.push(newNode);
            mindmapData.links.push({
                source: selectedNode.id,
                target: newNode.id
            });

            renderMindmap();
            saveMindmap();
        }

        // 删除选中的节点
        function deleteSelectedNode() {
            if (!selectedNode || selectedNode.id === 'root') {
                alert('请选择要删除的非根节点！');
                return;
            }

            mindmapData.nodes = mindmapData.nodes.filter(n => n.id !== selectedNode.id);
            mindmapData.links = mindmapData.links.filter(l => 
                l.source !== selectedNode.id && l.target !== selectedNode.id
            );

            selectedNode = null;
            renderMindmap();
            saveMindmap();
        }

        // 更新节点颜色
        function updateNodeColor(color) {
            if (!selectedNode) return;
            selectedNode.color = color;
            renderMindmap();
            saveMindmap();
        }

        // 更新节点形状
        function updateNodeShape(shape) {
            if (!selectedNode) return;
            selectedNode.shape = shape;
            renderMindmap();
            saveMindmap();
        }

        // 保存思维导图
        function saveMindmap() {
            mindmapData.title = document.getElementById('mindmap-title').value;
            mindmapData.updated_at = new Date().toISOString();
            
            // 保存当前思维导图
            localStorage.setItem(`mindmap_${mapId}`, JSON.stringify(mindmapData));
            
            // 更新思维导图列表
            const mindmaps = JSON.parse(localStorage.getItem('mindmaps') || '[]');
            const index = mindmaps.findIndex(m => m.id === mapId);
            if (index >= 0) {
                mindmaps[index] = {
                    id: mapId,
                    title: mindmapData.title,
                    updated_at: mindmapData.updated_at
                };
            } else {
                mindmaps.push({
                    id: mapId,
                    title: mindmapData.title,
                    updated_at: mindmapData.updated_at
                });
            }
            localStorage.setItem('mindmaps', JSON.stringify(mindmaps));
        }

        // 初始化
        loadMindmap();
    </script>
</body>
</html> 